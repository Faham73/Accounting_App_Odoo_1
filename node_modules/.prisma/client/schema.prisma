// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  INCOME
  EXPENSE
}

enum JournalType {
  GENERAL
  SALES
  PURCHASE
  BANK
  CASH
}

enum EntryStatus {
  DRAFT
  POSTED
}

enum InvoiceStatus {
  DRAFT
  POSTED
  PAID
  CANCELLED
}

// Models
model Company {
  id                String   @id @default(uuid())
  name              String
  baseCurrency      String
  invoiceNextNumber Int      @default(1)
  createdAt         DateTime @default(now())

  accounts         Account[]
  journals         Journal[]
  journalEntries   JournalEntry[]
  fiscalPeriods    FiscalPeriod[]
  partners         Partner[]
  customerInvoices CustomerInvoice[]

  @@map("companies")
}

model Account {
  id        String      @id @default(uuid())
  companyId String
  code      String
  name      String
  type      AccountType
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())

  company              Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  journalLines         JournalLine[]
  customerInvoiceLines CustomerInvoiceLine[]

  @@unique([companyId, code])
  @@index([companyId])
  @@map("accounts")
}

model Journal {
  id         String      @id @default(uuid())
  companyId  String
  code       String
  name       String
  type       JournalType
  nextNumber Int         @default(1)
  createdAt  DateTime    @default(now())

  company        Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  journalEntries JournalEntry[]

  @@unique([companyId, code])
  @@index([companyId])
  @@map("journals")
}

model JournalEntry {
  id        String      @id @default(uuid())
  companyId String
  journalId String
  date      DateTime
  number    String?
  status    EntryStatus @default(DRAFT)
  memo      String?
  createdAt DateTime    @default(now())
  postedAt  DateTime?

  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  journal         Journal          @relation(fields: [journalId], references: [id], onDelete: Cascade)
  journalLines    JournalLine[]
  customerInvoice CustomerInvoice?

  @@unique([companyId, number])
  @@index([companyId])
  @@index([journalId])
  @@map("journal_entries")
}

model JournalLine {
  id        String   @id @default(uuid())
  entryId   String
  accountId String
  partnerId String?
  label     String?
  debit     Decimal  @db.Decimal(18, 2)
  credit    Decimal  @db.Decimal(18, 2)
  createdAt DateTime @default(now())

  entry   JournalEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  account Account      @relation(fields: [accountId], references: [id], onDelete: Restrict)
  partner Partner?     @relation(fields: [partnerId], references: [id], onDelete: SetNull)

  @@index([entryId])
  @@index([accountId])
  @@index([partnerId])
  @@map("journal_lines")
}

model FiscalPeriod {
  id        String    @id @default(uuid())
  companyId String
  name      String
  startDate DateTime
  endDate   DateTime
  isClosed  Boolean   @default(false)
  closedAt  DateTime?

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("fiscal_periods")
}

model Partner {
  id         String   @id @default(cuid())
  companyId  String
  name       String
  email      String?
  phone      String?
  isCustomer Boolean  @default(false)
  isVendor   Boolean  @default(false)
  createdAt  DateTime @default(now())

  company          Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  journalLines     JournalLine[]
  customerInvoices CustomerInvoice[]

  @@unique([companyId, email])
  @@index([companyId])
  @@map("partners")
}

model CustomerInvoice {
  id             String        @id @default(uuid())
  companyId      String
  partnerId      String
  invoiceDate    DateTime
  dueDate        DateTime?
  number         String?
  status         InvoiceStatus @default(DRAFT)
  memo           String?
  currency       String
  totalAmount    Decimal       @db.Decimal(18, 2)
  journalEntryId String?       @unique
  createdAt      DateTime      @default(now())
  postedAt       DateTime?

  company      Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  partner      Partner               @relation(fields: [partnerId], references: [id], onDelete: Restrict)
  journalEntry JournalEntry?         @relation(fields: [journalEntryId], references: [id], onDelete: SetNull)
  lines        CustomerInvoiceLine[]

  @@unique([companyId, number])
  @@index([companyId])
  @@index([partnerId])
  @@index([journalEntryId])
  @@map("customer_invoices")
}

model CustomerInvoiceLine {
  id              String  @id @default(uuid())
  invoiceId       String
  description     String
  quantity        Decimal @default(1) @db.Decimal(18, 2)
  unitPrice       Decimal @db.Decimal(18, 2)
  lineTotal       Decimal @db.Decimal(18, 2)
  incomeAccountId String

  invoice       CustomerInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  incomeAccount Account         @relation(fields: [incomeAccountId], references: [id], onDelete: Restrict)

  @@index([invoiceId])
  @@index([incomeAccountId])
  @@map("customer_invoice_lines")
}
